<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<link rel="stylesheet" href="css/style.css" />
		<link rel="stylesheet" href="lib/bootstrap-5.2.3-dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="lib/bootstrap-5.2.3-dist/css/bootstrap.min.css.map" />
		<link rel="stylesheet" href="lib/material-master/css/material.min.css" />
		<link rel="stylesheet" href="lib/mdl/material.min.css" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
			rel="stylesheet" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />

		<style>
			/* adding styles */
			.toggle-buttons {
				display: flex;
				justify-content: center;
				gap: 1rem;
				margin-bottom: 1rem;
			}

			.toggle-btn {
				padding: 0.5rem 1rem;
				border: none;
				border-radius: 0.375rem;
				background-color: #e5e7eb;
				color: #4b5563;
				font-size: 1rem;
				font-weight: 500;
				cursor: pointer;
				transition: all 0.2s ease;
			}

			.toggle-btn.active,
			.toggle-btn:hover {
				background-color: #3b82f6;
				color: #ffffff;
			}

			.tab-content {
				display: block;
			}

			.tab-content.hidden {
				display: none;
			}

			.form-group {
				margin-bottom: 1rem;
			}

			.form-control {
				width: 100%;
				padding: 0.5rem;
				border: 1px solid #d1d5db;
				border-radius: 0.375rem;
				font-size: 1rem;
				transition: border-color 0.2s ease;
			}

			.form-control:focus {
				outline: none;
				border-color: #3b82f6;
				box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
			}

			.form-label {
				display: block;
				margin-bottom: 0.5rem;
				font-size: 0.875rem;
				font-weight: 500;
				color: #374151;
			}

			.btn {
				padding: 12px 8px;
				border-radius: 0.375rem;
				font-size: 1rem;
				font-weight: 600;
				cursor: pointer;
				transition: background-color 0.2s ease;
			}

			.btn-primary {
				background-color: #3b82f6;
				color: #ffffff;
				border: none;
			}

			.btn-primary:hover {
				background-color: #2563eb;
			}

			.btn-danger {
				background-color: #ef4444;
				color: #ffffff;
				border: none;
			}

			.btn-danger:hover {
				background-color: #dc2626;
			}

			.transport-grid {
				display: grid;
				grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
				gap: 1rem;
				max-height: 40rem;
				overflow-y: auto;
				padding: 0.5rem;
			}

			.transport-card {
				background-color: #f3f4f6;
				padding: 1rem 0rem;
				border-radius: 0.5rem;
				text-align: center;
				box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
				transition: box-shadow 0.2s ease;
				cursor: pointer;
			}

			.transport-card:hover {
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
			}

			.transport-number {
				font-size: 1.125rem;
				font-weight: 600;
				color: #1f2937;
				display: flex;
				align-items: center;
				justify-content: center;
				gap: 0.5rem;
			}

			.i-transport-icon {
				width: 24px;
				height: 24px;
				vertical-align: middle;
			}

			.radio-group {
				display: flex;
				gap: 16px;
				margin-bottom: 16px;
			}

			.radio-group label {
				font-size: 0.875rem;
				color: #374151;
			}

			.radio-group {
				gap: 8px;
			}
		</style>
	</head>
	<body>
		<div class="matrix-background" id="matrixBackground"></div>
		<canvas id="matrixCanvas"></canvas>
		<div id="loginContainer" class="container">
			<div class="row justify-content-center" style="height: 100vh">
				<div class="col-md-4">
					<h2 class="text-center">Вход</h2>
					<form id="loginForm">
						<div class="mb-3">
							<label for="password" class="form-label">Введите пароль:</label>
							<input type="password" class="form-control" id="password" required />
						</div>
						<button type="submit" class="btn btn-primary w-100">Войти</button>
						<p class="error text-center mt-2" id="errorMessage">Пароль неверный. Попробуйте снова.</p>
					</form>
				</div>
			</div>
		</div>

		<div id="content">
			<header class="py-2">
				<div class="container px-2">
					<div class="d-flex flex-column align-items-center">
						<div class="d-flex align-items-center w-100">
							<a href="#" class="d-flex align-items-center">
								<img src="img/arrow_left.png" alt="Arrow" style="width: 18px; height: 18px" />
							</a>
							<ul class="nav mb-0 mx-auto d-flex align-items-center">
								<li class="nav-item">
									<a href="#" class="nav-link px-2 text-secondary" id="text-main">Мои билеты</a>
								</li>
							</ul>
						</div>
						<div class="btn-group-toggle d-none" role="group" aria-label="Toggle buttons">
							<a href="#" class="btn" id="btn_one1">Транспорт</a>
							<a href="#" class="btn" id="btn_two">Другое</a>
						</div>
					</div>
				</div>
			</header>
			<div class="container" style="padding-bottom: 35rem; margin-bottom: 35rem">
				<div class="badge-custome d-flex justify-content-center">
					<span class="badge px-3 text-bg-primary mt-4 mb-2">Сегодня</span>
				</div>
				<div id="openCustomModal"></div>
				<div class="card" id="ticketCard" style="display: none">
					<div class="yellow-strip">
						<img src="img/onay.png" alt="Image in Yellow Strip" />
					</div>
					<div class="card-content py-2">
						<p id="text_01" class="transportTypeText">Автобус</p>
						<p class="mb-2" id="text_02">Алматы</p>
						<p class="align-items-center text-center pb-1">
							<span class="label">Маршрут:</span>
							<span class="value w-700 fs-14">
								<img src="img/bus.png" alt="bus icon" class="bus-icon transport-icon" />
								<span id="routeNumber">00</span>
								<span class="badge-custome-two badge mx-2 fs-14" id="ticketCode">009FJ00</span>
							</span>
						</p>
						<p class="pb-1">
							<span class="label">Время:</span>
							<span class="value w-700 fs-14" id="ticketTime">01.01.24 21:00</span>
						</p>
						<p class="pb-1">
							<span class="label">Цена:</span>
							<span class="value w-700 fs-14" id="ticketPrice">120 ₸</span>
						</p>
						<p class="pb-1">
							<span class="label">Код проверки:</span>
							<span class="value w-700 fs-14" id="verificationCodeDisplay"
								>3DF19 <img src="img/qr.png" alt="QR код" class="qr-icon mx-1"
							/></span>
						</p>
					</div>
				</div>

				<div class="d-flex justify-content-center" id="btn_one">
					<span class="badge-custome-add my-2 d-flex align-items-center">
						<img src="img/add-ticket.png" alt="Icon" class="me-0 icon-inside-badge" />
						Купить ещё
					</span>
				</div>

				<!-- Custom Modal for Ticket Details -->
				<div class="custom-modal-overlay" id="customModal">
					<div class="custom-modal-content animate__animated animate__fadeInUpBig animate__faster">
						<button class="custom-close-btn" id="closeCustomModal">&times;</button>
						<img src="img/ticket_empty.png" alt="Ticket Image" />
						<div class="custom-text-overlay">
							<p class="label" style="top: -8px; left: 0px; position: relative">Маршрут:</p>
							<p class="value" style="top: 30px; left: 10px; position: relative">
								<img
									src="img/bus.png"
									alt="bus icon"
									class="bus-icon"
									id="modalTransportIcon"
									style="top: -42px; left: -8px; position: relative" />
								<span class="fw-700 color-fb" id="modalRouteNumber" style="top: -39px; left: -18px; position: relative"
									>00</span
								>
								<span
									class="badge-custome-three badge fs-14"
									id="modalTicketCode"
									style="top: -42px; left: -8px; position: relative"
									>009FJ00</span
								>
							</p>
							<p class="label" style="top: 3px; left: 0px; position: relative">Время:</p>
							<p class="value fw-700" id="modalTicketTime" style="top: 2px; left: -1px; position: relative">
								00.00.24 00:00
							</p>
							<p class="label" style="top: 14px; left: 1px; position: relative">Код проверки:</p>
							<p
								class="value fw-700"
								id="modalVerificationCodeDisplay"
								style="top: 14px; left: 0px; position: relative; font-size: 30px !important">
								3DF19
							</p>
						</div>
					</div>
				</div>
			</div>

			<!-- Modal for Adding Ticket -->
			<div
				class="modal fade"
				id="addTicketModal"
				tabindex="-1"
				aria-labelledby="addTicketModalLabel"
				aria-hidden="true">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="addTicketModalLabel">Добавить билет</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>
						<div class="modal-body">
							<div class="toggle-buttons my-2">
								<button id="addTab" class="toggle-btn active">Добавить</button>
								<button id="selectTab" class="toggle-btn">Выбрать</button>
							</div>

							<div id="addSection" class="tab-content">
								<form id="ticketForm">
									<div class="form-group">
										<label for="transportType" class="form-label">Тип транспорта</label>
										<div class="radio-group">
											<input type="radio" id="bus" name="transportType" value="bus" checked />
											<label for="bus">Автобус</label>
											<input type="radio" id="trolleybus" name="transportType" value="trolleybus" />
											<label for="trolleybus">Троллейбус</label>
										</div>
									</div>
									<div class="form-group">
										<label for="additionalNumber" class="form-label">Добавочный номер</label>
										<input type="text" class="form-control" id="additionalNumber" />
									</div>
									<div class="form-group">
										<label for="ticketNumber" class="form-label">Номер транспорта</label>
										<input type="text" class="form-control" id="ticketNumber" required />
									</div>
									<div class="form-group">
										<label for="route" class="form-label">Маршрут</label>
										<input type="text" class="form-control" id="route" required />
									</div>
									<div class="form-group">
										<label for="time" class="form-label">Время</label>
										<input type="datetime-local" class="form-control" id="time" required />
									</div>
									<div class="form-group">
										<label for="codeLength" class="form-label">Длина кода проверки</label>
										<input type="number" class="form-control" id="codeLength" min="1" value="9" required />
									</div>
									<div class="form-group">
										<label for="verificationCode" class="form-label">Код проверки</label>
										<input type="text" class="form-control" id="verificationCode" />
									</div>
									<button type="button" class="btn btn-primary mb-3" onclick="generateVerificationCode()">
										Сгенерировать
									</button>
									<div class="form-group">
										<label for="price" class="form-label">Цена</label>
										<input type="number" class="form-control" id="price" value="120" required />
									</div>
									<button type="submit" class="btn btn-primary">Добавить</button>
									<button type="submit" class="btn btn-danger">Очистить</button>
								</form>
							</div>

							<div id="selectSection" class="tab-content hidden">
								<div class="form-group">
									<input
										type="text"
										id="searchTransport"
										class="form-control"
										placeholder="Поиск по номеру транспорта" />
								</div>
								<div class="transport-grid"></div>
							</div>
						</div>
					</div>
				</div>
			</div>

			<footer class="d-none">
				<img src="img/footer.png" alt="Footer Image" />
			</footer>
		</div>
		<script src="lib/bcrypt.min.js"></script>
		<script src="js/script.js"></script>
		<script src="lib/bootstrap-5.2.3-dist/js/bootstrap.bundle.min.js"></script>
		<script src="lib/jquery/jquery-3.7.1.min.js"></script>
		<script src="lib/material-master/js/material.min.js"></script>
		<script src="lib/mdl/material.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<script>
			function generateVerificationCode() {
				const codeLength = parseInt(document.getElementById('codeLength').value) || 8
				const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
				let verificationCode = ''
				for (let i = 0; i < codeLength; i++) {
					const randomIndex = Math.floor(Math.random() * characters.length)
					verificationCode += characters.charAt(randomIndex)
				}
				document.getElementById('verificationCode').value = verificationCode
				return verificationCode
			}

			document.addEventListener('DOMContentLoaded', function () {
				const SUPABASE_URL = 'https://eyhanthbvtfisucxctso.supabase.co'
				const SUPABASE_ANON_KEY =
					'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5aGFudGhidnRmaXN1Y3hjdHNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzNjYxMDQsImV4cCI6MjA3MDk0MjEwNH0.aM4wHWRbRyLn0xEJGoqnK7U_OCO5YWexZkQwQ8MfvaE'
				const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

				const addTicketModal = document.getElementById('addTicketModal')
				const addTab = document.getElementById('addTab')
				const selectTab = document.getElementById('selectTab')
				const addSection = document.getElementById('addSection')
				const selectSection = document.getElementById('selectSection')
				const searchTransport = document.getElementById('searchTransport')

				function getCurrentDateTimeLocal() {
					const now = new Date()
					const year = now.getFullYear()
					const month = String(now.getMonth() + 1).padStart(2, '0')
					const day = String(now.getDate()).padStart(2, '0')
					const hours = String(now.getHours()).padStart(2, '0')
					const minutes = String(now.getMinutes()).padStart(2, '0')
					return `${year}-${month}-${day}T${hours}:${minutes}`
				}

				function saveTicketToLocalStorage(ticket) {
					const tickets = JSON.parse(localStorage.getItem('tickets') || '[]')
					const exists = tickets.some(
						t =>
							t.ticketNumber === ticket.ticketNumber &&
							t.additionalNumber === ticket.additionalNumber &&
							t.route === ticket.route &&
							t.time === ticket.time,
					)
					if (!exists) {
						tickets.push(ticket)
						localStorage.setItem('tickets', JSON.stringify(tickets))
						cleanupExpiredTickets()
					}
				}

				function cleanupExpiredTickets(tickets = null) {
					const TWELVE_HOURS = 12 * 60 * 60 * 1000 // 12 hours in milliseconds
					tickets = tickets || JSON.parse(localStorage.getItem('tickets') || '[]')
					const now = Date.now()
					const validTickets = tickets.filter(ticket => now - ticket.createdAt < TWELVE_HOURS)
					localStorage.setItem('tickets', JSON.stringify(validTickets))
					return validTickets
				}

				function clearLocalStorage() {
					localStorage.removeItem('tickets')
					const container = document.getElementById('openCustomModal')
					container.innerHTML = ''
					container.style.display = 'none'
				}

				function loadStoredTickets() {
					const tickets = JSON.parse(localStorage.getItem('tickets') || '[]')
					const validTickets = cleanupExpiredTickets(tickets)
					const TWO_HOURS = 2 * 60 * 60 * 1000 // 2 hours in milliseconds
					const now = Date.now()

					const activeTickets = validTickets
						.filter(ticket => now - ticket.createdAt < TWO_HOURS)
						.sort((a, b) => b.createdAt - a.createdAt)
					const inactiveTickets = validTickets
						.filter(ticket => now - ticket.createdAt >= TWO_HOURS)
						.sort((a, b) => b.createdAt - a.createdAt)

					const sortedTickets = [...activeTickets, ...inactiveTickets]

					const container = document.getElementById('openCustomModal')
					container.innerHTML = ''
					container.style.display = sortedTickets.length ? 'block' : 'none'

					sortedTickets.forEach(ticket => {
						const ticketTemplate = document.getElementById('ticketCard').cloneNode(true)
						ticketTemplate.removeAttribute('id')
						ticketTemplate.style.display = 'block'

						if (now - ticket.createdAt >= TWO_HOURS) {
							ticketTemplate.id = 'inactiveTicketCard'
							const yellowStrip = ticketTemplate.querySelector('.yellow-strip')
							if (yellowStrip) {
								yellowStrip.classList.remove('yellow-strip')
								yellowStrip.classList.add('inactive-yellow-strip')
							}
							const yellowStripImg = ticketTemplate.querySelector('.inactive-yellow-strip img')
							if (yellowStripImg) {
								yellowStripImg.src = 'img/onay_out.png'
								yellowStripImg.alt = 'Image in Gray Strip'
							}
						}

						const routeNumberEl = ticketTemplate.querySelector('#routeNumber')
						const ticketCodeEl = ticketTemplate.querySelector('#ticketCode')
						const ticketTimeEl = ticketTemplate.querySelector('#ticketTime')
						const ticketPriceEl = ticketTemplate.querySelector('#ticketPrice')
						const verificationCodeEl = ticketTemplate.querySelector('#verificationCodeDisplay')
						const transportIconEl = ticketTemplate.querySelector('.transport-icon') // Исправлено: поиск по классу внутри ticketTemplate

						const fullTicketCode = ticket.additionalNumber
							? `(${ticket.additionalNumber})${ticket.ticketNumber}`
							: ticket.ticketNumber

						if (routeNumberEl) routeNumberEl.textContent = ticket.route
						if (ticketCodeEl) ticketCodeEl.textContent = fullTicketCode
						if (ticketTimeEl) ticketTimeEl.textContent = ticket.time
						if (ticketPriceEl) ticketPriceEl.textContent = ticket.price + ' ₸'
						if (verificationCodeEl)
							verificationCodeEl.innerHTML =
								ticket.verificationCode + ' <img src="img/qr.png" alt="QR код" class="qr-icon mx-1">'
						const transportIconSrc = ticket.transportType === 'bus' ? 'img/bus.png' : 'img/trolleybus.png'
						if (transportIconEl) {
							transportIconEl.src = transportIconSrc
							transportIconEl.alt = ticket.transportType === 'bus' ? 'bus icon' : 'trolleybus icon'
							transportIconEl.removeAttribute('id') // Удаляем id, чтобы избежать дублирования
						}

						const transportTextEl = ticketTemplate.querySelector('.transportTypeText')
						if (transportTextEl) transportTextEl.textContent = ticket.transportType === 'bus' ? 'Автобус' : 'Троллейбус'

						if (now - ticket.createdAt < TWO_HOURS) {
							ticketTemplate.addEventListener('click', function () {
								const customModal = document.getElementById('customModal')
								const modalContent = customModal.querySelector('.custom-modal-content')

								modalContent.classList.remove('animate__fadeOutDownBig')
								modalContent.classList.add('animate__animated', 'animate__fadeInUpBig', 'animate__faster')

								document.getElementById('modalRouteNumber').textContent = ticket.route
								const modalTicketCodeEl = document.getElementById('modalTicketCode')
								if (modalTicketCodeEl) {
									modalTicketCodeEl.textContent =
										fullTicketCode.length >= 13
											? `(${ticket.additionalNumber})${ticket.ticketNumber.slice(0, 4)}...`
											: fullTicketCode
								}
								document.getElementById('modalTicketTime').textContent = ticket.time
								document.getElementById('modalVerificationCodeDisplay').textContent = ticket.verificationCode
								document.getElementById('modalTransportIcon').src = transportIconSrc
								document.getElementById('modalTransportIcon').alt =
									ticket.transportType === 'bus' ? 'bus icon' : 'trolleybus icon'
								customModal.style.display = 'block'

								modalContent.addEventListener(
									'animationend',
									function handler() {
										modalContent.classList.remove('animate__animated', 'animate__fadeInUpBig', 'animate__faster')
										modalContent.removeEventListener('animationend', handler)
									},
									{ once: true },
								)
							})
						}

						container.appendChild(ticketTemplate)
					})
				}

				addTicketModal.addEventListener('shown.bs.modal', function () {
					generateVerificationCode()
					loadStoredTickets()
				})

				document.getElementById('btn_one').addEventListener('click', function (event) {
					event.preventDefault()
					generateVerificationCode()
					const myModal = new bootstrap.Modal(addTicketModal)
					myModal.show()
				})

				const form = document.getElementById('ticketForm')
				const submitButton = form.querySelector('button[type="submit"]')

				form.addEventListener('submit', async function (event) {
					event.preventDefault()

					if (submitButton) {
						submitButton.disabled = true
					}

					const transportType = document.querySelector('input[name="transportType"]:checked')?.value
					const ticketNumber = document.getElementById('ticketNumber').value
					const additionalNumber = document.getElementById('additionalNumber').value || ''
					const route = document.getElementById('route').value
					const time = document.getElementById('time').value
					const price = document.getElementById('price').value
					const verificationCode = document.getElementById('verificationCode').value

					if (!transportType) {
						alert('Выберите тип транспорта')
						if (submitButton) submitButton.disabled = false
						return
					}
					if (!ticketNumber || !route) {
						alert('Заполните обязательные поля: Номер билета и Маршрут')
						if (submitButton) submitButton.disabled = false
						return
					}

					const { data: existing, error: selectError } = await supabase
						.from('bus_data')
						.select('id')
						.eq('number', ticketNumber)
						.eq('additional', additionalNumber || '')
						.eq('transport', route)

					if (selectError) {
						alert('Ошибка при проверке данных: ' + selectError.message)
						if (submitButton) submitButton.disabled = false
						return
					}

					if (existing.length === 0) {
						const { error } = await supabase.from('bus_data').insert([
							{
								transport: route,
								additional: additionalNumber || null,
								number: ticketNumber,
								transport_type: transportType,
							},
						])
						if (error) {
							alert('Ошибка при сохранении в базу данных: ' + error.message)
							if (submitButton) submitButton.disabled = false
							return
						}
					}

					const dateObj = new Date(time)
					const formattedDate =
						('0' + dateObj.getDate()).slice(-2) +
						'.' +
						('0' + (dateObj.getMonth() + 1)).slice(-2) +
						'.' +
						dateObj.getFullYear().toString().slice(-2)
					const formattedTime = ('0' + dateObj.getHours()).slice(-2) + ':' + ('0' + dateObj.getMinutes()).slice(-2)
					const formattedDateTime = formattedDate + ' ' + formattedTime

					const fullTicketCode = additionalNumber ? `(${additionalNumber})${ticketNumber}` : ticketNumber

					saveTicketToLocalStorage({
						transportType,
						ticketNumber,
						additionalNumber,
						route,
						time: formattedDateTime,
						price,
						verificationCode,
						createdAt: Date.now(),
					})

					loadStoredTickets()

					try {
						const myModal = bootstrap.Modal.getInstance(document.getElementById('addTicketModal'))
						if (myModal) {
							myModal.hide()
						}
					} catch (error) {
						alert('Ошибка при закрытии модального окна: ' + error.message)
					}

					form.reset()
					if (submitButton) submitButton.disabled = false
				})

				document.getElementById('closeCustomModal').addEventListener('click', function () {
					const customModal = document.getElementById('customModal')
					const modalContent = customModal.querySelector('.custom-modal-content')

					modalContent.classList.add('animate__animated', 'animate__fadeOutDownBig', 'animate__faster')

					modalContent.addEventListener(
						'animationend',
						function handler() {
							modalContent.classList.remove('animate__animated', 'animate__fadeOutDownBig', 'animate__faster')
							modalContent.classList.add('animate__fadeInUpBig')
							customModal.style.display = 'none'
							modalContent.removeEventListener('animationend', handler)
						},
						{ once: true },
					)
				})

				document.querySelector('.btn.btn-danger').addEventListener('click', function (event) {
					event.preventDefault()
					clearLocalStorage()
				})

				async function fetchTransportNumbers() {
					const { data, error } = await supabase
						.from('bus_data')
						.select('transport, additional, number, transport_type')

					if (error) {
						alert('Ошибка при получении данных: ' + error.message)
						return []
					}

					return data.map(item => ({
						display: `<img src="img/${item.transport_type}.png" alt="${
							item.transport_type
						}" class="i-transport-icon"> ${item.transport} ${item.additional ? `(${item.additional})` : ''}${
							item.number
						}`,
						searchable: `${item.transport_type}-${item.transport} ${item.transport} ${item.additional || ''}${
							item.number
						}`,
						transport_type: item.transport_type,
						transport: item.transport,
						additional: item.additional || '',
						number: item.number,
					}))
				}

				function renderTransportNumbers(numbers) {
					const container = selectSection.querySelector('.transport-grid')
					container.innerHTML = ''
					numbers.forEach(item => {
						const div = document.createElement('div')
						div.className = 'transport-card'
						div.innerHTML = `<p class="transport-number">${item.display}</p>`
						div.addEventListener('click', event => {
							event.preventDefault()
							event.stopPropagation()

							const transportType =
								item.transport_type.toLowerCase() === 'bus' || item.transport_type.toLowerCase() === 'trolleybus'
									? item.transport_type.toLowerCase()
									: 'bus'
							const radio = document.querySelector(`input[name="transportType"][value="${transportType}"]`)
							if (radio) {
								radio.checked = true
							}
							const additionalNumberInput = document.getElementById('additionalNumber')
							const ticketNumberInput = document.getElementById('ticketNumber')
							const routeInput = document.getElementById('route')
							const timeInput = document.getElementById('time')

							if (additionalNumberInput) additionalNumberInput.value = item.additional
							if (ticketNumberInput) ticketNumberInput.value = item.number
							if (routeInput) routeInput.value = item.transport
							if (timeInput) timeInput.value = getCurrentDateTimeLocal()

							if (addTab && selectTab && addSection && selectSection) {
								addTab.classList.add('active')
								selectTab.classList.remove('active')
								addSection.classList.remove('hidden')
								selectSection.classList.add('hidden')
								try {
									const tab = new bootstrap.Tab(addTab)
									tab.show()
								} catch (error) {
									alert('Ошибка при переключении на вкладку "Добавить": ' + error.message)
								}
							}
						})
						container.appendChild(div)
					})
				}

				async function loadAndRenderTransportNumbers() {
					const transportNumbers = await fetchTransportNumbers()
					renderTransportNumbers(transportNumbers)
				}

				addTab.addEventListener('click', () => {
					addTab.classList.add('active')
					selectTab.classList.remove('active')
					addSection.classList.remove('hidden')
					selectSection.classList.add('hidden')
				})

				selectTab.addEventListener('click', async () => {
					selectTab.classList.add('active')
					addTab.classList.remove('active')
					selectSection.classList.remove('hidden')
					addSection.classList.add('hidden')
					await loadAndRenderTransportNumbers()
				})

				searchTransport.addEventListener('input', async e => {
					const query = e.target.value.toLowerCase()
					const transportNumbers = await fetchTransportNumbers()
					const filteredNumbers = transportNumbers.filter(item => item.searchable.toLowerCase().includes(query))
					renderTransportNumbers(filteredNumbers)
				})

				loadStoredTickets()
			})
		</script>
	</body>
</html>
